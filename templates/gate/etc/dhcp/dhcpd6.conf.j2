# Managed by ansible. Editing is useless
# Sheridan
{% set interface = network|selectattr('ifname', 'match', 'internal_.*')|first %}

ddns-update-style none;
authoritative;
option dhcp6.name-servers {{ networks.home.gateway.ipv6.ip }};
option dhcp6.domain-search "{{ networks.home.domain }}";
default-lease-time {{ dhcp.lease_time }};
max-lease-time {{ dhcp.lease_time * 4 }};
option client-class-information code  97 = string;
# one-lease-per-client true;
deny duplicates;
ping-check true;
# allow leasequery;
update-optimization false;

shared-network "sheridan-home"
{
  interface {{ interface.ifname }};
  # subnet6 {{ query('ship', 'delegated_v6_net').full }} {}
  # subnet6 {{ query('ship', 'henet_net').full }} {}
  subnet6 {{ networks.home.subnet.ipv6.full }}
  {
    pool6
    {
      # Range for clients
      range6 {{ query('ship', 'ip', 1).ipv6.ip }} {{ query('ship', 'ip', 254).ipv6.ip }};

      # Range for clients requesting a temporary address
      range6 {{ networks.home.subnet.ipv6.full }} temporary;

      # Prefix range for delegation to sub-routers
      prefix6 {{ query('ship', 'ip', 210).ipv6.network.net }} {{ query('ship', 'ip', 220).ipv6.network.net }} /64;
    }
  }
}

{% for inventory_hostname in query('inventory_hostnames', 'all')|difference(['gate'])|sort -%}
  {% for hostname_interface in hostvars[inventory_hostname].network -%}
    {% if 'mac' in hostname_interface and 'ipv6' in hostname_interface.ip -%}
      host {{ inventory_hostname }}_{{ hostname_interface.mac|regex_replace(':', '_') }}
      {
        hardware ethernet {{ hostname_interface.mac }};
        {% if 'duid' in hostname_interface -%}
          host-identifier option dhcp6.client-id {{ hostname_interface.duid }};
        {% endif -%}
        fixed-address6 {{ hostname_interface.ip.ipv6.ip }};
        # fixed-prefix6 {{ networks.home.subnet.ipv6.full }};
      } # Interface name: {% if 'ifname' in hostname_interface -%} {{ hostname_interface.ifname }} {% endif -%} ({{ hostname_interface.name }})

    {% endif -%}
  {% endfor -%}
{% endfor -%}

if known
{
    log(info, concat("DUID: "         , option dhcp6.client-id,
                     " interface-id: ", option dhcp6.interface-id,
                     " remote-id: "   , option dhcp6.remote-id));
}

# http://www.ipamworldwide.com/ipam/isc-dhcpv6-options.html
# https://linux.die.net/man/5/dhcpd-eval
# https://build.opensuse.org/package/view_file/openSUSE:Factory/dhcp/dhcpd6.conf
