#!/bin/bash

{% set external_interfaces_rt = network|selectattr('ifname', 'match', 'external_rt.*')|first %}
{% set external_interfaces_kis = network|selectattr('ifname', 'match', 'external_kis.*')|first %}

ip route add default via {{ networks.kis.gateway.ipv4.ip }} dev {{ external_interfaces_kis.ifname }} proto static table to_{{ external_interfaces_kis.ifname }}
ip route add default dev {{ external_interfaces_rt.ifname }} table to_{{ external_interfaces_rt.ifname }}

{% for router_path in merged_vars.router_paths -%}
ip rule add fwmark {{ router_path.mark }} table to_{{ router_path.interface.ifname }}
{# -#}
{%- endfor %}

ip route flush cache
