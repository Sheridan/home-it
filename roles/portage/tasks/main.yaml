---
  - name: Устанавливаем нужные пакеты
    portage:
      package: "{{ item }}"
      state: present
    with_items:
    - app-portage/cpuid2cpuflags
    tags:
    - packages

  - name: Определяем флаги cpu
    shell: "cpuid2cpuflags | sed -e 's/CPU_FLAGS_X86: //'"
    register: cpu_flags
    check_mode: no
    changed_when: false

  - name: Установка флагов cpu
    replace:
      path: /etc/portage/make.conf
      regexp: 'CPU_FLAGS_X86=".+?"'
      replace: 'CPU_FLAGS_X86="{{ cpu_flags.stdout }}"'

  - name: Установка флагов компилятора
    replace:
      path: /etc/portage/make.conf
      regexp: 'COMMON_FLAGS=".+?"'
      replace: 'COMMON_FLAGS="{{ portage_compiler_flags|join(" ") }}"'

  - name: Установка количества потоков при сборке
    replace:
      path: /etc/portage/make.conf
      regexp: 'MAKEOPTS=".+?"'
      replace: 'MAKEOPTS="-j{{ ansible_processor_vcpus }}"'

  - name: Установка расширений при сборке
    replace:
      path: /etc/portage/make.conf
      regexp: 'FEATURES=".+?"'
      replace: 'FEATURES="{{ portage_features|join(" ") }}"'

  - name: Установка зеркала
    replace:
      path: /etc/portage/make.conf
      regexp: 'GENTOO_MIRRORS=".+?"'
      replace: 'GENTOO_MIRRORS="{{ portage_mirror }}"'
#CPU_FLAGS_X86="aes avx avx2 fma3 mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3"
# MAKEOPTS="-j8"
# FEATURES="splitdebug"
#COMMON_FLAGS=="-march=native -O2 -pipe"
#GENTOO_MIRRORS="http://mirror.yandex.ru/gentoo-distfiles/"
