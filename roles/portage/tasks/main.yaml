---
  - name: Определяем флаги cpu
    shell: "cpuid2cpuflags | sed -e 's/CPU_FLAGS_X86: //'"
    register: cpu_flags_out
    check_mode: no
    changed_when: false

  - name: Собираем факты
    set_fact:
      cpu_flags: "{{ cpu_flags_out.stdout  }}"
      portage_fact:
        directoryes:
          portdir: "{{ merged_vars.portage.directoryes.portdir | default('/usr/portage') }}"
          distdir: "{{ merged_vars.portage.directoryes.distdir | default('/usr/portage/distfiles') }}"
          pkgdir: "{{ merged_vars.portage.directoryes.pkgdir | default('/usr/portage/packages') }}"
          tmp: "{{ merged_vars.portage.directoryes.tmp | default('/var/tmp/portage') }}"

  - name: Создаём каталоги для нужд portage
    file:
      dest: "{{ item }}"
      state: directory
      owner: portage
      group: root
    with_items:
      - /etc/portage/package.use
      - /etc/portage/package.accept_keywords
      - /etc/portage/package.mask
      - /etc/portage/package.unmask
      - "{{ portage_fact.directoryes.portdir }}"
      - "{{ portage_fact.directoryes.distdir }}"
      - "{{ portage_fact.directoryes.pkgdir }}"
      - "{{ portage_fact.directoryes.tmp }}"

  - name: Генерируем make.conf
    template:
      src: templates/etc/portage/make.conf.j2
      dest: /etc/portage/make.conf
      owner: portage
      group: root
      mode: 0644

  - name: Принимаем все лицензии
    copy:
      content: "*/* *\n"
      dest: /etc/portage/package.license
      owner: portage

  - name: Устанавливаем внеролевые пакеты
    include_role:
      name: portage
      tasks_from: install_package
    vars:
      package: "{{ item }}"
    loop: "{{ merged_vars.portage.packages }}"
    tags:
    - packages
