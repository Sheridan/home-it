---
- import_playbook: deploy-nginx.yaml
- import_playbook: setup-pppoe.yaml
- import_playbook: deploy-linux-hosts.yaml
- hosts: gate
  remote_user: root
  vars_files:
  - vars/network.yaml
  - vars/pppoe.yaml

  handlers:
  - import_tasks: handlers/systemd.yaml

  tasks:

  - name: Install packages
    portage:
      package: "{{ item }}"
      state: present
    with_items:
    - net-dialup/rp-pppoe

  - name: Sysctl setup
    sysctl:
      name: "{{ item.key }}"
      value: "{{ item.value }}"
      state: "{{ item.state|default('present') }}"
      sysctl_set: yes
      reload: yes
    with_items:
    - { key: net.ipv6.conf.all.disable_ipv6,value: 0 }
    - { key: net.ipv6.conf.default.disable_ipv6, value: 0 }
    - { key: net.ipv6.conf.lo.disable_ipv6, value: 0 }
    - { key: net.ipv6.conf.bridge_rt_0.disable_ipv6, value: 1 }
    - { key: net.ipv6.conf.all.forwarding, value: 1 }
    - { key: net.ipv6.conf.default.forwarding, value: 1 }
    - { key: net.ipv4.ip_forward, value: 1 }
    - { key: net.ipv4.conf.default.forwarding, value: 1 }
